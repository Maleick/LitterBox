{% extends "base.html" %}

{% block page_title %}Remote Credentials Wizard{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <div class="bg-black/60 backdrop-blur-lg rounded-xl border border-gray-800 shadow-xl p-8 space-y-6">
        <div class="flex items-start justify-between gap-4">
            <div>
                <h3 class="text-xl font-medium text-gray-100">Remote Credential Setup</h3>
                <p class="text-sm text-gray-400 mt-2">
                    Credentials are stored automatically by this LitterBox instance.
                </p>
            </div>
            <button
                id="toggleAddHostBtn"
                type="button"
                class="px-3 py-2 rounded-lg border border-blue-700 text-blue-300 hover:bg-blue-900/20 text-sm font-medium"
            >
                Add Host
            </button>
        </div>

        <div class="rounded-lg border border-blue-800/40 bg-blue-900/10 p-4 hidden" id="addHostPanel">
            <h4 class="text-sm font-medium text-blue-200 mb-3">Add WinRM Host Target</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="md:col-span-2">
                    <label for="new_host" class="block text-sm text-gray-300 mb-2">Host</label>
                    <input
                        id="new_host"
                        type="text"
                        class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200"
                        placeholder="server01.nuthatch-chickadee.ts.net"
                    />
                    <p class="text-xs text-gray-500 mt-2">
                        A target ID is derived from the first hostname label (for example, <code>domain.example.ts.net</code> becomes <code>domain</code>).
                    </p>
                </div>
            </div>
            <div class="mt-3">
                <button
                    id="addHostBtn"
                    type="button"
                    class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium"
                >
                    Save Host
                </button>
            </div>
        </div>

        <div>
            <label for="token" class="block text-sm text-gray-300 mb-2">Setup Token</label>
            <input id="token" type="password" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
            <p class="text-xs text-gray-500 mt-2">
                Required for saving credentials, deleting credentials, and adding/deleting hosts.
            </p>
        </div>

        {% if credential_hosts|length == 0 %}
        <div class="rounded-lg border border-yellow-800/30 bg-yellow-500/10 p-4 text-yellow-300 text-sm">
            No WinRM targets are configured under <code class="text-yellow-200">analysis.remote.targets</code>. Add one host to continue.
        </div>
        {% else %}
        <form id="remoteCredsForm" method="post" action="/setup/remote-credentials" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label for="target_id" class="block text-sm text-gray-300 mb-2">Host Target</label>
                    <select id="target_id" name="target_id" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required>
                        {% for target in credential_hosts %}
                        <option value="{{ target.target_id }}">
                            {{ target.host }} ({{ target.target_id }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="domain" class="block text-sm text-gray-300 mb-2">Domain (optional)</label>
                    <input id="domain" name="domain" type="text" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" placeholder="VANGUARD" />
                </div>
                <div>
                    <label for="account_type" class="block text-sm text-gray-300 mb-2">Account Type</label>
                    <select id="account_type" name="account_type" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required>
                        <option value="domain">domain</option>
                        <option value="local">local</option>
                    </select>
                </div>
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-2">Username</label>
                    <input id="username" name="username" type="text" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-2">Password</label>
                    <input id="password" name="password" type="password" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
                </div>
            </div>

            <div>
                <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium">
                    Save Credentials
                </button>
            </div>
        </form>
        {% endif %}

        <span id="wizardStatus" class="text-sm text-gray-400"></span>
    </div>

    <div class="bg-black/60 backdrop-blur-lg rounded-xl border border-gray-800 shadow-xl p-8">
        <h4 class="text-lg font-medium text-gray-100 mb-4">Configured Host Targets</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead>
                    <tr class="text-gray-300 border-b border-gray-700">
                        <th class="py-2 pr-4">Target</th>
                        <th class="py-2 pr-4">Host</th>
                        <th class="py-2 pr-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if credential_hosts|length == 0 %}
                    <tr class="border-b border-gray-800 text-gray-500">
                        <td class="py-3 pr-4" colspan="3">No host targets configured.</td>
                    </tr>
                    {% endif %}
                    {% for target in credential_hosts %}
                    <tr class="border-b border-gray-800 text-gray-400">
                        <td class="py-2 pr-4 font-mono text-gray-200">{{ target.target_id }}</td>
                        <td class="py-2 pr-4">{{ target.host }}</td>
                        <td class="py-2 pr-4">
                            <button
                                type="button"
                                class="delete-host-btn px-3 py-1 rounded border border-red-800 text-red-300 hover:bg-red-900/20 disabled:opacity-40 disabled:cursor-not-allowed"
                                data-target-id="{{ target.target_id }}"
                            >
                                Delete Host
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-black/60 backdrop-blur-lg rounded-xl border border-gray-800 shadow-xl p-8">
        <h4 class="text-lg font-medium text-gray-100 mb-4">Stored Entries (Masked)</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead>
                    <tr class="text-gray-300 border-b border-gray-700">
                        <th class="py-2 pr-4">Target</th>
                        <th class="py-2 pr-4">Host</th>
                        <th class="py-2 pr-4">Domain</th>
                        <th class="py-2 pr-4">Account Type</th>
                        <th class="py-2 pr-4">Username</th>
                        <th class="py-2 pr-4">Password</th>
                        <th class="py-2 pr-4">Updated</th>
                        <th class="py-2 pr-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stored_entries|length == 0 %}
                    <tr class="border-b border-gray-800 text-gray-500">
                        <td class="py-3 pr-4" colspan="8">
                            No stored credential entries found for configured WinRM targets.
                        </td>
                    </tr>
                    {% endif %}
                    {% for row in stored_entries %}
                    {% set target_id = row.target_id %}
                    {% set entry = row.entry %}
                    <tr class="border-b border-gray-800 text-gray-400">
                        <td class="py-2 pr-4 font-mono text-gray-200">{{ target_id }}</td>
                        <td class="py-2 pr-4">{{ entry.get('host', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('domain', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('account_type', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('username', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('password', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('updated_at', '') }}</td>
                        <td class="py-2 pr-4">
                            <button
                                type="button"
                                class="delete-credential-btn px-3 py-1 rounded border border-red-800 text-red-300 hover:bg-red-900/20 disabled:opacity-40 disabled:cursor-not-allowed"
                                data-target-id="{{ target_id }}"
                            >
                                Delete Credentials
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
    const form = document.getElementById("remoteCredsForm");
    const statusElement = document.getElementById("wizardStatus");
    const tokenInput = document.getElementById("token");
    const addHostInput = document.getElementById("new_host");
    const addHostBtn = document.getElementById("addHostBtn");
    const toggleAddHostBtn = document.getElementById("toggleAddHostBtn");
    const addHostPanel = document.getElementById("addHostPanel");
    const deleteCredentialButtons = document.querySelectorAll(".delete-credential-btn");
    const deleteHostButtons = document.querySelectorAll(".delete-host-btn");

    function setStatus(color, message) {
        if (!statusElement) {
            return;
        }
        statusElement.className = `text-sm ${color}`;
        statusElement.textContent = message;
    }

    function refreshPage() {
        setTimeout(() => window.location.assign(window.location.pathname), 500);
    }

    function requireToken() {
        const token = (tokenInput?.value || "").toString().trim();
        if (!token) {
            setStatus("text-red-400", "Setup token is required");
            return "";
        }
        return token;
    }

    if (toggleAddHostBtn && addHostPanel) {
        toggleAddHostBtn.addEventListener("click", () => {
            addHostPanel.classList.toggle("hidden");
        });
    }

    if (addHostBtn) {
        addHostBtn.addEventListener("click", async () => {
            const token = requireToken();
            if (!token) {
                return;
            }

            const host = (addHostInput?.value || "").toString().trim();
            if (!host) {
                setStatus("text-red-400", "host is required");
                return;
            }

            const formData = new FormData();
            formData.append("host", host);
            formData.append("token", token);

            setStatus("text-gray-400", "Adding host target...");
            try {
                const response = await fetch("/setup/remote-credentials/hosts", {
                    method: "POST",
                    body: formData,
                });

                const payload = await response.json();
                if (!response.ok) {
                    setStatus("text-red-400", payload.error || "Host add request failed");
                    return;
                }

                setStatus("text-green-400", payload.message || "Host added. Refreshing view...");
                refreshPage();
            } catch (error) {
                setStatus("text-red-400", "Unexpected error while adding host");
            }
        });
    }

    if (form) {
        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            setStatus("text-gray-400", "");

            const token = requireToken();
            if (!token) {
                return;
            }

            const formData = new FormData(form);
            const requiredKeys = ["target_id", "account_type", "username", "password"];
            for (const key of requiredKeys) {
                const value = (formData.get(key) || "").toString().trim();
                if (!value) {
                    setStatus("text-red-400", `${key} is required`);
                    return;
                }
            }
            formData.append("token", token);

            try {
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                });

                let payload = {};
                const contentType = response.headers.get("content-type") || "";
                if (contentType.includes("application/json")) {
                    payload = await response.json();
                } else {
                    payload = { error: await response.text() };
                }

                if (!response.ok) {
                    const errorMessage = payload.error || JSON.stringify(payload.errors || {}) || "Request failed";
                    setStatus("text-red-400", errorMessage);
                    return;
                }

                setStatus("text-green-400", "Saved successfully. Refreshing view...");
                refreshPage();
            } catch (error) {
                setStatus("text-red-400", "Unexpected error while saving credentials");
            }
        });
    }

    deleteCredentialButtons.forEach((button) => {
        button.addEventListener("click", async () => {
            const token = requireToken();
            if (!token) {
                return;
            }

            const targetId = (button.dataset.targetId || "").trim();
            if (!targetId) {
                return;
            }

            if (!window.confirm(`Delete stored credentials for target "${targetId}"?`)) {
                return;
            }

            setStatus("text-gray-400", "Deleting credentials...");
            const formData = new FormData();
            formData.append("target_id", targetId);
            formData.append("token", token);

            try {
                const response = await fetch("/setup/remote-credentials/delete", {
                    method: "POST",
                    body: formData,
                });

                let payload = {};
                const contentType = response.headers.get("content-type") || "";
                if (contentType.includes("application/json")) {
                    payload = await response.json();
                } else {
                    payload = { error: await response.text() };
                }

                if (!response.ok) {
                    setStatus("text-red-400", payload.error || "Delete request failed");
                    return;
                }

                setStatus("text-green-400", payload.message || "Credentials deleted. Refreshing view...");
                refreshPage();
            } catch (error) {
                setStatus("text-red-400", "Unexpected error while deleting credentials");
            }
        });
    });

    deleteHostButtons.forEach((button) => {
        button.addEventListener("click", async () => {
            const token = requireToken();
            if (!token) {
                return;
            }

            const targetId = (button.dataset.targetId || "").trim();
            if (!targetId) {
                return;
            }

            if (!window.confirm(`Delete host target "${targetId}" and its credentials?`)) {
                return;
            }

            setStatus("text-gray-400", "Deleting host target...");
            const formData = new FormData();
            formData.append("target_id", targetId);
            formData.append("token", token);

            try {
                const response = await fetch("/setup/remote-credentials/hosts/delete", {
                    method: "POST",
                    body: formData,
                });

                let payload = {};
                const contentType = response.headers.get("content-type") || "";
                if (contentType.includes("application/json")) {
                    payload = await response.json();
                } else {
                    payload = { error: await response.text() };
                }

                if (!response.ok) {
                    setStatus("text-red-400", payload.error || "Host delete request failed");
                    return;
                }

                setStatus("text-green-400", payload.message || "Host deleted. Refreshing view...");
                refreshPage();
            } catch (error) {
                setStatus("text-red-400", "Unexpected error while deleting host");
            }
        });
    });
})();
</script>
{% endblock %}
