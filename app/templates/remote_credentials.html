{% extends "base.html" %}

{% block page_title %}Remote Credentials Wizard{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <div class="bg-black/60 backdrop-blur-lg rounded-xl border border-gray-800 shadow-xl p-8">
        <div class="flex items-start justify-between gap-4 mb-6">
            <div>
                <h3 class="text-xl font-medium text-gray-100">Remote Credential Setup</h3>
                <p class="text-sm text-gray-400 mt-2">
                    Stores credentials in <code class="text-red-400">{{ env_file_path }}</code>.
                    WinRM targets consume these values at runtime.
                </p>
            </div>
        </div>

        {% if credential_targets|length == 0 %}
        <div class="rounded-lg border border-yellow-800/30 bg-yellow-500/10 p-4 text-yellow-300 text-sm">
            No WinRM targets are configured under <code class="text-yellow-200">analysis.remote.targets</code>.
        </div>
        {% else %}
        <form id="remoteCredsForm" method="post" action="/setup/remote-credentials" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label for="env_path" class="block text-sm text-gray-300 mb-2">Credential ENV Path</label>
                    <input
                        id="env_path"
                        name="env_path"
                        type="text"
                        class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200"
                        value="{{ env_file_path }}"
                        placeholder="/opt/LitterBox/.env.remote"
                    />
                    <p class="text-xs text-gray-500 mt-2">
                        Use an absolute path or a project-relative path. Target credential keys in that file are preserved per target.
                    </p>
                </div>
                <div>
                    <label for="target_id" class="block text-sm text-gray-300 mb-2">Target ID</label>
                    <select id="target_id" name="target_id" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required>
                        {% for target in credential_targets %}
                        <option value="{{ target.id }}">
                            {{ target.id }}{% if target.host %} ({{ target.host }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="host" class="block text-sm text-gray-300 mb-2">Host</label>
                    <input id="host" name="host" type="text" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" placeholder="server01.nuthatch-chickadee.ts.net" required />
                </div>
                <div>
                    <label for="domain" class="block text-sm text-gray-300 mb-2">Domain (optional)</label>
                    <input id="domain" name="domain" type="text" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" placeholder="LAB" />
                </div>
                <div>
                    <label for="account_type" class="block text-sm text-gray-300 mb-2">Account Type</label>
                    <select id="account_type" name="account_type" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required>
                        <option value="domain">domain</option>
                        <option value="local">local</option>
                    </select>
                </div>
                <div>
                    <label for="username" class="block text-sm text-gray-300 mb-2">Username</label>
                    <input id="username" name="username" type="text" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
                </div>
                <div>
                    <label for="password" class="block text-sm text-gray-300 mb-2">Password</label>
                    <input id="password" name="password" type="password" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
                </div>
                <div class="md:col-span-2">
                    <label for="token" class="block text-sm text-gray-300 mb-2">Setup Token</label>
                    <input id="token" name="token" type="password" class="w-full bg-gray-900/70 border border-gray-700 rounded-lg px-3 py-2 text-gray-200" required />
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium">
                    Save Credentials
                </button>
                <span id="wizardStatus" class="text-sm text-gray-400"></span>
            </div>
        </form>
        {% endif %}
    </div>

    <div class="bg-black/60 backdrop-blur-lg rounded-xl border border-gray-800 shadow-xl p-8">
        <h4 class="text-lg font-medium text-gray-100 mb-4">Stored Entries (Masked)</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead>
                    <tr class="text-gray-300 border-b border-gray-700">
                        <th class="py-2 pr-4">Target</th>
                        <th class="py-2 pr-4">Host</th>
                        <th class="py-2 pr-4">Domain</th>
                        <th class="py-2 pr-4">Account Type</th>
                        <th class="py-2 pr-4">Username</th>
                        <th class="py-2 pr-4">Password</th>
                        <th class="py-2 pr-4">Updated</th>
                        <th class="py-2 pr-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stored_entries|length == 0 %}
                    <tr class="border-b border-gray-800 text-gray-500">
                        <td class="py-3 pr-4" colspan="8">
                            No stored credential entries found for configured WinRM targets.
                        </td>
                    </tr>
                    {% endif %}
                    {% for row in stored_entries %}
                    {% set target_id = row.target_id %}
                    {% set entry = row.entry %}
                    <tr class="border-b border-gray-800 text-gray-400">
                        <td class="py-2 pr-4 font-mono text-gray-200">{{ target_id }}</td>
                        <td class="py-2 pr-4">{{ entry.get('host', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('domain', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('account_type', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('username', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('password', '') }}</td>
                        <td class="py-2 pr-4">{{ entry.get('updated_at', '') }}</td>
                        <td class="py-2 pr-4">
                            <button
                                type="button"
                                class="delete-credential-btn px-3 py-1 rounded border border-red-800 text-red-300 hover:bg-red-900/20 disabled:opacity-40 disabled:cursor-not-allowed"
                                data-target-id="{{ target_id }}"
                            >
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
    const form = document.getElementById("remoteCredsForm");
    const statusElement = document.getElementById("wizardStatus");
    const envPathInput = document.getElementById("env_path");
    const tokenInput = document.getElementById("token");
    const deleteButtons = document.querySelectorAll(".delete-credential-btn");
    if (!form || !statusElement) {
        return;
    }

    const requiredKeys = ["target_id", "host", "account_type", "username", "password", "token"];

    function buildRefreshUrl() {
        const url = new URL(window.location.href);
        const envPath = (envPathInput?.value || "").toString().trim();
        if (envPath) {
            url.searchParams.set("env_path", envPath);
        } else {
            url.searchParams.delete("env_path");
        }
        return url.toString();
    }

    form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusElement.className = "text-sm text-gray-400";
        statusElement.textContent = "";

        const formData = new FormData(form);
        for (const key of requiredKeys) {
            const value = (formData.get(key) || "").toString().trim();
            if (!value) {
                statusElement.className = "text-sm text-red-400";
                statusElement.textContent = `${key} is required`;
                return;
            }
        }

        try {
            const response = await fetch(form.action, {
                method: "POST",
                body: formData
            });

            let payload = {};
            const contentType = response.headers.get("content-type") || "";
            if (contentType.includes("application/json")) {
                payload = await response.json();
            } else {
                const text = await response.text();
                payload = { error: text || "Request failed" };
            }

            if (!response.ok) {
                const errorMessage = payload.error || JSON.stringify(payload.errors || {}) || "Request failed";
                statusElement.className = "text-sm text-red-400";
                statusElement.textContent = errorMessage;
                return;
            }

            statusElement.className = "text-sm text-green-400";
            statusElement.textContent = "Saved successfully. Refreshing view...";
            setTimeout(() => window.location.assign(buildRefreshUrl()), 600);
        } catch (error) {
            statusElement.className = "text-sm text-red-400";
            statusElement.textContent = "Unexpected error while saving credentials";
        }
    });

    deleteButtons.forEach((button) => {
        button.addEventListener("click", async () => {
            const targetId = (button.dataset.targetId || "").trim();
            if (!targetId) {
                return;
            }

            const token = (tokenInput?.value || "").toString().trim();
            if (!token) {
                statusElement.className = "text-sm text-red-400";
                statusElement.textContent = "Setup token is required to delete credentials";
                return;
            }

            if (!window.confirm(`Delete stored credentials for target "${targetId}"?`)) {
                return;
            }

            statusElement.className = "text-sm text-gray-400";
            statusElement.textContent = "Deleting credentials...";

            const formData = new FormData();
            formData.append("target_id", targetId);
            formData.append("token", token);
            formData.append("env_path", (envPathInput?.value || "").toString().trim());

            try {
                const response = await fetch("/setup/remote-credentials/delete", {
                    method: "POST",
                    body: formData
                });

                let payload = {};
                const contentType = response.headers.get("content-type") || "";
                if (contentType.includes("application/json")) {
                    payload = await response.json();
                } else {
                    payload = { error: await response.text() };
                }

                if (!response.ok) {
                    statusElement.className = "text-sm text-red-400";
                    statusElement.textContent = payload.error || "Delete request failed";
                    return;
                }

                statusElement.className = "text-sm text-green-400";
                statusElement.textContent = payload.message || "Deleted. Refreshing view...";
                setTimeout(() => window.location.assign(buildRefreshUrl()), 500);
            } catch (error) {
                statusElement.className = "text-sm text-red-400";
                statusElement.textContent = "Unexpected error while deleting credentials";
            }
        });
    });
})();
</script>
{% endblock %}
